<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="assets/main.css">
	<link rel="stylesheet" type="text/css" href="assets/vendor/leaflet.css">
</head>
<body>
	<div id="mapa">
	</div>

	<table>
		<thead>
			<tr>
				<th>Nome</th>
				<th>Nickname</th>
				<th>Data</th>
			</tr>
		</thead>
		<tbody id="tabela">
		</tbody>
	</table>
	<script src="assets/vendor/leaflet.js" type="text/javascript"></script>
	<script src="assets/main.js" type="text/javascript"></script>
	<script type="text/javascript">
	(function () {
		"use strict"

		var map = L.map('mapa').setView([51.505, -0.09], 13);
		
		L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
		    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		function atualizaTabela() {
			var xmlhttp = new XMLHttpRequest();

			var url = "http://www.jiujitsuteam.com";

			xmlhttp.onreadystatechange = function() {
	    		if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
		        	var myArr = JSON.parse(xmlhttp.responseText);
		        	parseJson(myArr);
	    		}
			}
			xmlhttp.open("GET", url + "/teams.json", true);
			xmlhttp.send();
		}

		function parseJson(times) {
			var tabela = document.getElementById("tabela");

		    for(var i = 0; i < times.length; i++) {

				var linha = document.createElement("tr");
				linha.className = "linha-time";

				var celulaNome = document.createElement("td");
				var celulaNickname = document.createElement("td");
				var celulaData = document.createElement("td");

				celulaNome.innerText = times[i].name;
				celulaNickname.innerText = times[i].nickname;
				celulaData.innerText = new Date(times[i].created_at).toLocaleDateString();

				linha.appendChild(celulaNome);
				linha.appendChild(celulaNickname);
				linha.appendChild(celulaData);

				linha.setAttribute("data-id", times[i].id);
				linha.onclick = exibeMarkersDoTime

				tabela.appendChild(linha);
		    }
		}

		function exibeMarkersDoTime() {
			var id = this.getAttribute("data-id");

			buscaMarkers(id, function (jsonTimes) {
				var latLngs = [];

				jsonTimes.places.forEach(function (place) {
					if (place.gym && place.gym.lat && place.gym.lng) {
						var lat = parseFloat(place.gym.lat), lng = parseFloat(place.gym.lng);
						L.marker([lat, lng]).addTo(map);
						latLngs.push([lat, lng]);
					}
				});

				if (latLngs.length > 0) {
					var bounds = new L.LatLngBounds(latLngs);
					map.fitBounds(bounds);
				}
			})
		}

		function buscaMarkers(idTime, callback) {
			
			var xmlhttp = new XMLHttpRequest();

			var url = "http://www.jiujitsuteam.com";

			xmlhttp.onreadystatechange = function() {
	    		if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
		        	var myArr = JSON.parse(xmlhttp.responseText);
		        	callback(myArr);
	    		}
			}

			xmlhttp.open("GET", url + "/teams/" + idTime + ".json", true);
			xmlhttp.send();
		}

		atualizaTabela();


	})();
	</script>
</body>
</html>
